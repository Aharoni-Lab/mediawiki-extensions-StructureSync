---
phase: 04-conditional-templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Generator/TemplateGenerator.php
  - tests/phpunit/unit/Generator/TemplateGeneratorTest.php
autonomous: true

must_haves:
  truths:
    - "Every property line in generated semantic templates is wrapped in #if guard"
    - "Multi-value properties (non-Page or Page without namespace) use +sep=, parameter"
    - "Multi-value Page properties with allowedNamespace retain #arraymap wrapped in #if"
    - "Subobject templates guard all properties with #if, same pattern as category templates"
    - "All existing tests pass with updated assertions matching new output patterns"
  artifacts:
    - path: "src/Generator/TemplateGenerator.php"
      provides: "Conditional #if guards and +sep for all generated semantic/subobject templates"
      contains: "#if:{{{.*|}}}|"
    - path: "tests/phpunit/unit/Generator/TemplateGeneratorTest.php"
      provides: "Updated test assertions matching conditional template output"
      contains: "#if:{{{.*|}}}|"
  key_links:
    - from: "generatePropertyLine()"
      to: "generateSemanticTemplate() and generateSubobjectTemplate()"
      via: "return value consumed in #set block assembly"
      pattern: "generatePropertyLine"
    - from: "generateInlineAnnotation()"
      to: "generateSemanticTemplate()"
      via: "return value placed after #set block, now wrapped in #if"
      pattern: "generateInlineAnnotation"
---

<objective>
Add conditional `#if` guards to all property lines in generated semantic and subobject templates, and switch multi-value properties to `+sep=,` parameter.

Purpose: Prevent empty values from being stored as SMW annotations when multiple category templates set the same property on a multi-category page. Without `#if` guards, SMW accumulates all values including empty strings from templates where the property is not relevant.

Output: Modified TemplateGenerator producing conditional template output, with all tests updated.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-conditional-templates/04-CONTEXT.md
@.planning/phases/04-conditional-templates/04-RESEARCH.md
@src/Generator/TemplateGenerator.php
@tests/phpunit/unit/Generator/TemplateGeneratorTest.php
@src/Schema/PropertyModel.php
@src/Schema/SubobjectModel.php
@src/Util/NamingHelper.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add #if guards and +sep to TemplateGenerator output</name>
  <files>src/Generator/TemplateGenerator.php</files>
  <action>
Modify four methods in TemplateGenerator.php. The goal is to wrap every property value in `{{#if:{{{param|}}}|...|}}` and add `|+sep=,` for multi-value properties.

**1. `generatePropertyLine()` (lines 52-75):**

Change the method so ALL property lines get `#if` guards, not just Page-type with namespace. The logic branches:

- **Default / non-Page / no namespace:** Change from:
  `' | ' . $propertyName . ' = {{{' . $param . '|}}}'`
  To:
  `' | ' . $propertyName . ' = {{#if:{{{' . $param . '|}}}|{{{' . $param . '|}}}|}}'`

- **Multi-value (non-Page or Page without namespace):** Return the `#if` guard WITH `+sep=,` appended:
  `' | ' . $propertyName . ' = {{#if:{{{' . $param . '|}}}|{{{' . $param . '|}}}|}}|+sep=,'`
  Note: These properties currently return the simple `' | ' . $propertyName . ' = {{{' . $param . '|}}}'` line. The method needs to check `$propModel->allowsMultipleValues()` for non-null propModels, and for null propModels (property not found in store) use the default non-multi-value pattern.

- **Single-value Page-type with namespace (already has #if):** Keep the existing pattern:
  `' | ' . $propertyName . ' = {{#if:{{{' . $param . '|}}}|' . $allowedNamespace . ':{{{' . $param . '|}}}|}}'`
  This already has the `#if` guard -- no change needed.

- **Multi-value Page-type with namespace:** Keep returning `null` (handled by inline annotation).

The restructured logic for `generatePropertyLine()`:
```
1. Read propModel from store
2. If no propModel: return default #if-guarded line (no +sep, we don't know if multi-value)
3. Get allowedNamespace, isPageType, allowsMultipleValues from propModel
4. If Page-type AND has namespace AND multi-value: return null (inline annotation)
5. If Page-type AND has namespace AND single-value: return existing conditional namespace prefix pattern (already has #if)
6. If multi-value (non-Page or Page without namespace): return #if-guarded line WITH +sep=,
7. Otherwise (single-value, non-Page or no namespace): return #if-guarded line
```

**2. `generateInlineAnnotation()` (lines 87-95):**

Wrap the entire `#arraymap` output in an `#if` guard. Change from:
```php
return '{{#arraymap:{{{' . $param . '|}}}|,|@@item@@|[[' . $propertyName . '::' . $allowedNamespace . ':@@item@@]]|}}';
```
To:
```php
return '{{#if:{{{' . $param . '|}}}|{{#arraymap:{{{' . $param . '|}}}|,|@@item@@|[[' . $propertyName . '::' . $allowedNamespace . ':@@item@@]]|}}|}}';
```

**3. `generateSemanticTemplate()` (lines 107-156):**

No structural changes needed. The method already calls `generatePropertyLine()` and `generateInlineAnnotation()` which now produce the guarded output. No modifications required to this method.

**4. `generateSubobjectTemplate()` (lines 232-263):**

The method already calls `generatePropertyLine()` for each property. Since `generatePropertyLine()` now returns `#if`-guarded lines, this method automatically gets the new behavior.

However, check one thing: the subobject method currently does NOT handle multi-value properties (it skips null returns from `generatePropertyLine()`). For multi-value non-Page properties in subobjects, the updated `generatePropertyLine()` will now return a line with `+sep=,` instead of null, which is correct. No structural change needed.

Also note: The `' | Has subobject type = Subobject:' . $name` line (line 242) is a fixed value, NOT a template parameter. It should NOT get an `#if` guard -- it is always set. Leave it as-is.
  </action>
  <verify>
Run `composer test` to verify no syntax errors and existing tests still compile. Tests may fail at this point since assertions expect old output patterns -- that is expected and addressed in Task 2.

Also manually inspect the generated output by reading the modified file and tracing through `generatePropertyLine()` logic for these cases:
- Standard property (e.g., "Has email" with param "email") -> should produce ` | Has email = {{#if:{{{email|}}}|{{{email|}}}|}}`
- Multi-value property -> should produce ` | Has keywords = {{#if:{{{keywords|}}}|{{{keywords|}}}|}}|+sep=,`
- Page-type with namespace (single) -> should keep existing ` | Has X = {{#if:{{{x|}}}|Namespace:{{{x|}}}|}}`
- Page-type with namespace (multi) -> generatePropertyLine returns null, generateInlineAnnotation wraps #arraymap in #if
  </verify>
  <done>
All four method branches produce correct `#if`-guarded output. `generatePropertyLine()` returns `+sep=,` for multi-value properties. `generateInlineAnnotation()` wraps `#arraymap` in `#if`. No PHP syntax errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tests for conditional template output</name>
  <files>tests/phpunit/unit/Generator/TemplateGeneratorTest.php</files>
  <action>
Update existing test assertions to match the new conditional output patterns, and add new tests covering the `#if` guard and `+sep` behavior.

**Update existing tests:**

1. `testGenerateSemanticTemplateContainsPropertyMappings()` (line 78):
   Currently asserts `{{{name|}}}` and `{{{email|}}}` appear in output. These still appear (inside the `#if` guard), so these assertions may still pass. BUT also add assertions that the `#if` pattern is present:
   - Assert `{{#if:{{{name|}}}|{{{name|}}}|}}` is in result
   - Assert `{{#if:{{{email|}}}|{{{email|}}}|}}` is in result

2. `testPropertyToParameterConversionInTemplate()` (line 199):
   Currently asserts `{{{full_name|}}}` in result. Still passes (appears inside `#if`). Add assertion for full pattern:
   - Assert `{{#if:{{{full_name|}}}|{{{full_name|}}}|}}` is in result

3. `testMultiplePropertiesConvertedCorrectly()` (line 213):
   Currently asserts `{{{first_name|}}}`, `{{{last_name|}}}`, `{{{email_address|}}}`. Still pass. Add `#if` pattern assertions for each.

**Add new tests:**

4. `testGenerateSemanticTemplateWrapsPropertiesInIfGuard()`:
   Create CategoryModel with 'Has name' required. Assert output contains `{{#if:{{{name|}}}|{{{name|}}}|}}`. This is the core requirement TMPL-01.

5. `testGenerateSemanticTemplateUsePlusSepForMultiValue()`:
   This test needs a multi-value property. Since `generatePropertyLine()` calls `$this->propertyStore->readProperty()`, and the test constructor passes `null` for propertyStore (which creates a default WikiPropertyStore), the readProperty will return null for unknown properties.

   When propModel is null, `generatePropertyLine()` returns the default `#if`-guarded line WITHOUT `+sep`. To test `+sep`, you need to mock the WikiPropertyStore to return a PropertyModel with `allowsMultipleValues() = true`.

   Create a test that:
   - Mocks WikiPropertyStore to return a PropertyModel with `allowsMultipleValues()` returning true, `isPageType()` returning false
   - Creates TemplateGenerator with the mocked store
   - Creates CategoryModel with that property
   - Asserts output contains `|+sep=,`

6. `testGenerateSemanticTemplateIfGuardForPageTypeWithNamespace()`:
   Mock WikiPropertyStore returning PropertyModel that is Page-type with allowedNamespace 'Property', single-value. Assert the existing pattern `{{#if:{{{param|}}}|Property:{{{param|}}}|}}` is in output. This pattern already exists and should not change.

7. `testGenerateSemanticTemplateInlineAnnotationWrappedInIf()`:
   Mock WikiPropertyStore returning PropertyModel that is Page-type with allowedNamespace 'Subobject', multi-value. Assert output contains `{{#if:{{{param|}}}|{{#arraymap:` pattern.

8. `testGenerateSubobjectTemplateWrapsPropertiesInIfGuard()`:
   Test that subobject template generation also produces `#if` guards. Create a SubobjectModel with properties, call `generateSubobjectTemplate()` (this is private -- you may need to test via `generateAllTemplates()` or make the test use reflection, OR test indirectly by checking `generateSemanticTemplate()` which uses the same `generatePropertyLine()`).

   Since `generateSubobjectTemplate()` is private, the most practical approach: verify `generatePropertyLine()` produces guarded output for all cases (already covered by tests 4-7), which guarantees subobject templates also get guards since `generateSubobjectTemplate()` calls `generatePropertyLine()`.

   Alternatively, if testability matters, add a focused integration-style test via `generateAllTemplates()` with a mocked SubobjectStore that returns a SubobjectModel. The `generateAllTemplates()` method calls `generateSubobjectTemplate()` internally.

**Important:** When creating PropertyModel mocks for these tests, use `$this->createMock(PropertyModel::class)` and configure methods: `isPageType()`, `getAllowedNamespace()`, `allowsMultipleValues()`. When creating WikiPropertyStore mocks, configure `readProperty($propertyName)` to return the mocked PropertyModel.

The constructor signature is `TemplateGenerator(?PageCreator, ?WikiSubobjectStore, ?WikiPropertyStore)`. For tests that need property mocking, pass the mocked WikiPropertyStore as third argument.
  </action>
  <verify>
Run `php vendor/bin/phpunit tests/phpunit/unit/Generator/TemplateGeneratorTest.php` -- all tests must pass.
Then run `composer test` for full suite (lint, phpcs, phpunit) -- all checks must pass.
  </verify>
  <done>
All existing tests updated to assert `#if` guard patterns. New tests added covering: standard `#if` guard, `+sep=,` for multi-value, Page-type namespace prefix, inline annotation `#if` wrapping. Full test suite passes with zero failures.
  </done>
</task>

</tasks>

<verification>
1. `composer test` passes (parallel-lint, minus-x, phpcs, phpunit)
2. Generated semantic template for a category with properties contains `{{#if:{{{param|}}}|{{{param|}}}|}}` for every property
3. Multi-value properties include `|+sep=,` after the `#if` guard
4. Page-type properties with namespace prefix retain their conditional namespace pattern
5. Multi-value Page-type with namespace retain `#arraymap` wrapped in `#if`
6. Subobject templates produce same `#if` guard pattern
7. The `Has subobject type` fixed line in subobject templates does NOT have an `#if` guard (it's a constant, not a parameter)
</verification>

<success_criteria>
- TMPL-01: All semantic templates wrap `#set` property values in `#if` conditions
- TMPL-02: Existing single-category templates produce correct output (same properties stored, just with guards)
- TMPL-03: Multi-value properties use `+sep=,` instead of bare comma-separated values
- All PHPUnit tests pass including new conditional template tests
- `composer test` clean (no lint/style/test failures)
</success_criteria>

<output>
After completion, create `.planning/phases/04-conditional-templates/04-01-SUMMARY.md`
</output>
