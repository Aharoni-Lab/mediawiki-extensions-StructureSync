---
phase: 02-system-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Schema/PropertyModel.php
autonomous: false

must_haves:
  truths:
    - "Page-type properties without custom template use Template:Property/Page"
    - "Properties with custom Has_template still use their custom template"
    - "Non-Page properties without custom template use Template:Property/Default"
    - "Regenerated display templates show Page-type values as clickable links"
  artifacts:
    - path: "src/Schema/PropertyModel.php"
      provides: "Smart template fallback logic in getRenderTemplate()"
      contains: "isPageType()"
  key_links:
    - from: "src/Schema/PropertyModel.php::getRenderTemplate()"
      to: "src/Generator/DisplayStubGenerator.php:210"
      via: "$property->getRenderTemplate()"
      pattern: "getRenderTemplate\\(\\)"
---

<objective>
Page-type properties automatically use Template:Property/Page through smart fallback logic.

Purpose: Completes the feature by wiring the template (created in Phase 1) to Page-type properties automatically, without requiring explicit Has_template annotation on every property.

Output: Modified PropertyModel with datatype-aware template selection and verified clickable links in display templates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-system-integration/02-RESEARCH.md
@.planning/phases/01-template-foundation/01-01-SUMMARY.md
@.planning/phases/01-template-foundation/01-02-SUMMARY.md
@src/Schema/PropertyModel.php
@src/Generator/DisplayStubGenerator.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement smart template fallback in getRenderTemplate()</name>
  <files>src/Schema/PropertyModel.php</files>
  <action>
Modify the `getRenderTemplate()` method (lines 263-265) to implement the three-level fallback chain:

```php
public function getRenderTemplate(): string {
    // Priority 1: Explicit custom template
    if ( $this->hasTemplate !== null ) {
        return $this->hasTemplate;
    }
    // Priority 2: Datatype-specific template for Page type
    if ( $this->isPageType() ) {
        return 'Template:Property/Page';
    }
    // Fallback: Default template
    return 'Template:Property/Default';
}
```

Key requirements:
- Check `$this->hasTemplate !== null` FIRST (preserve custom template override)
- Use existing `isPageType()` method for datatype check
- Return exact string `'Template:Property/Page'` (case-sensitive)
- Keep `'Template:Property/Default'` as final fallback

Do NOT modify DisplayStubGenerator - it already calls `$property->getRenderTemplate()` correctly.
  </action>
  <verify>
Run PHPUnit tests to ensure no regressions:
```bash
php vendor/bin/phpunit
```
All tests should pass. If PropertyModel tests exist, they verify the method behavior.
  </verify>
  <done>
`getRenderTemplate()` returns:
- Custom template when `hasTemplate` is set
- `Template:Property/Page` for Page-type properties without custom template
- `Template:Property/Default` for other property types without custom template
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify display templates render Page-type values as clickable links</name>
  <what-built>
Smart template fallback logic in PropertyModel that automatically selects Template:Property/Page for Page-type properties. This wires the template (created in Phase 1) to actual Page-type properties system-wide.
  </what-built>
  <how-to-verify>
1. **Start Docker test environment** (if not running):
   ```bash
   bash tests/scripts/reinstall_test_env.sh
   ```

2. **Regenerate display templates** via Special:SemanticSchemas:
   - Navigate to http://localhost:8889/wiki/Special:SemanticSchemas
   - Click "Regenerate" for a category with Page-type properties (e.g., Property category has "Has parent category" which is Page-type)
   - Alternatively, use maintenance script:
     ```bash
     docker exec wiki php /mw-user-extensions/SemanticSchemas/maintenance/regenerateArtifacts.php
     ```

3. **View a page with Page-type property values**:
   - Navigate to a property page that has "Has parent category" filled in
   - Or view any page in a category that uses Page-type properties

4. **Verify clickable links**:
   - Page-type property values should render as blue clickable links
   - Clicking a link should navigate to the correct page
   - Multi-value properties should show comma-separated links

5. **Verify fallback behavior** (optional advanced check):
   - View raw wikitext of a display template (`Template:SomeCategory/display`)
   - Page-type properties should call `{{Template:Property/Page | value=...}}`
   - Non-Page properties should still call `{{Template:Property/Default | value=...}}`
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 2 success criteria verification:

1. **PropertyModel.getRenderTemplate() returns custom template when Has_template is set**
   - Create a PropertyModel with `hasTemplate: 'Template:Property/Email'`
   - Call `getRenderTemplate()` - should return `'Template:Property/Email'`

2. **PropertyModel.getRenderTemplate() returns 'Template:Property/Page' for Page-type properties without custom template**
   - Create a PropertyModel with `datatype: 'Page'` and no hasTemplate
   - Call `getRenderTemplate()` - should return `'Template:Property/Page'`

3. **PropertyModel.getRenderTemplate() returns 'Template:Property/Default' for other property types**
   - Create a PropertyModel with `datatype: 'Text'` and no hasTemplate
   - Call `getRenderTemplate()` - should return `'Template:Property/Default'`

4. **Existing display templates regenerated show Page-type values as clickable links**
   - Verified via human checkpoint after regeneration

5. **Multi-value Page-type properties display as comma-separated link list**
   - Template:Property/Page already handles this (from Phase 1)
   - Verified via human checkpoint
</verification>

<success_criteria>
- [ ] `getRenderTemplate()` modified with fallback chain (Task 1)
- [ ] PHPUnit tests pass (Task 1 verification)
- [ ] Human verifies clickable links in browser (Task 2 checkpoint)
- [ ] REQ-001, REQ-002, REQ-004 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-system-integration/02-01-SUMMARY.md`
</output>
