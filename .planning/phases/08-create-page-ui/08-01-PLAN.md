---
phase: 08-create-page-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Api/ApiSemanticSchemasMultiCategory.php
  - tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php
autonomous: true

must_haves:
  truths:
    - "API response includes datatype for each property"
    - "API response includes targetNamespace for each resolved category"
    - "Existing API consumers continue working (backward-compatible response shape)"
  artifacts:
    - path: "src/Api/ApiSemanticSchemasMultiCategory.php"
      provides: "Enhanced API with datatype and namespace fields"
      contains: "datatype"
    - path: "tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php"
      provides: "Tests covering datatype and namespace fields"
      contains: "datatype"
  key_links:
    - from: "src/Api/ApiSemanticSchemasMultiCategory.php"
      to: "WikiPropertyStore::getAllProperties()"
      via: "Property lookup for datatype"
      pattern: "propertyStore.*getAllProperties\\|getDatatype"
    - from: "src/Api/ApiSemanticSchemasMultiCategory.php"
      to: "CategoryModel::getTargetNamespace()"
      via: "Category namespace lookup"
      pattern: "getTargetNamespace"
---

<objective>
Enhance the semanticschemas-multicategory API to include property datatypes and category target namespaces in the response.

Purpose: The Create Page UI (Plan 03) needs datatypes to display in the property preview and target namespaces to detect namespace conflicts. The current API only returns name, title, required, shared, and sources. Without this enhancement, the UI cannot show datatype badges or namespace conflict pickers.

Output: Enhanced API response with `datatype` field on each property and `categories` changed from string array to object array with `name` and `targetNamespace`.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-create-page-ui/08-RESEARCH.md
@.planning/phases/07-api-endpoint/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance API response with datatype and namespace fields</name>
  <files>src/Api/ApiSemanticSchemasMultiCategory.php</files>
  <action>
Modify `ApiSemanticSchemasMultiCategory::execute()` to:

1. After resolving properties via MultiCategoryResolver, load property datatypes:
   - Instantiate `WikiPropertyStore` (same pattern as existing code uses `WikiCategoryStore`)
   - Call `$propertyStore->getAllProperties()` to get PropertyModel objects
   - Build a lookup map: `$datatypeMap[$property->getName()] = $property->getDatatype()`

2. Modify the `categories` field in the response from a string array to an object array:
   - Currently: `'categories' => $categoryNames` (array of strings)
   - New: `'categories' => $this->formatCategories($categoryNames, $allCategories)` (array of objects)
   - Each object: `{ "name": "Person", "targetNamespace": null }` or `{ "name": "Employee", "targetNamespace": "Staff" }`
   - Get targetNamespace from `$allCategories[$name]->getTargetNamespace()` (CategoryModel already loaded for validation)

3. Add `datatype` field to `formatProperties()`:
   - Accept `$datatypeMap` as a second parameter
   - Add `'datatype' => $datatypeMap[$property] ?? 'Page'` to each formatted property entry
   - Default to 'Page' if property not found in store (defensive fallback)

4. Pass `$datatypeMap` from `execute()` to `formatProperties()`.

5. Add a new private method `formatCategories(array $categoryNames, array $allCategories): array` that maps each category name to `{ name, targetNamespace }`.

Do NOT change `formatSubobjects()` -- subobjects do not need datatype info for the UI.
Do NOT change the parameter signature or add new parameters. This is response-only enhancement.

Import: `use MediaWiki\Extension\SemanticSchemas\Store\WikiPropertyStore;`
  </action>
  <verify>
Run `composer test` -- all existing tests and linting must pass.
Verify the new `formatCategories` method exists and the response shape matches:
```json
{
  "categories": [{ "name": "Person", "targetNamespace": null }],
  "properties": [{ "name": "Has name", "datatype": "Text", ... }]
}
```
  </verify>
  <done>API response includes `datatype` on every property and `targetNamespace` on every category object. Existing fields (name, title, required, shared, sources) unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Update unit tests for new API response fields</name>
  <files>tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php</files>
  <action>
Update the existing `TestableApiHelper` class and tests in `ApiSemanticSchemasMultiCategoryTest.php`:

1. Update `TestableApiHelper::formatProperties()` to accept a `$datatypeMap` parameter and include `'datatype'` in output (mirror the production code change).

2. Add a new test method `testFormatPropertiesIncludesDatatype()`:
   - Create properties with known datatypes in the map
   - Assert each formatted property has a `'datatype'` key
   - Assert the datatype matches the map value
   - Assert a property NOT in the map gets the fallback value 'Page'

3. Add a new test method `testFormatCategoriesWithNamespaces()`:
   - Create category objects with `getTargetNamespace()` returning null and "Staff"
   - Assert the formatted output is an array of objects with `name` and `targetNamespace`
   - Assert null namespaces are preserved as null (not empty string)

4. Update ALL existing test methods that call `formatProperties()` to pass the new `$datatypeMap` parameter (can be empty array `[]` for backward compatibility tests).

5. Verify existing assertions still hold -- adding datatype should not break existing field checks.

Run `php vendor/bin/phpunit tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php` to confirm all tests pass.
  </action>
  <verify>
Run `php vendor/bin/phpunit tests/phpunit/unit/Api/ApiSemanticSchemasMultiCategoryTest.php` -- all tests pass.
Run `composer test` -- full suite passes.
  </verify>
  <done>All existing tests updated and passing. New tests cover datatype field inclusion, datatype fallback, and category namespace formatting.</done>
</task>

</tasks>

<verification>
1. `composer test` passes (phpcs, parallel-lint, minus-x, phpunit)
2. API response shape verified: `categories` is array of objects with `name` + `targetNamespace`, `properties` include `datatype`
3. Existing API fields unchanged: `name`, `title`, `required`, `shared`, `sources` still present on properties
</verification>

<success_criteria>
- API returns `datatype` field for every property in the response
- API returns `targetNamespace` field for every category in the response
- All existing tests continue passing (backward compatibility)
- New tests cover datatype lookup, fallback, and namespace formatting
</success_criteria>

<output>
After completion, create `.planning/phases/08-create-page-ui/08-01-SUMMARY.md`
</output>
