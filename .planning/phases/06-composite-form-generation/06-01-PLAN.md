---
phase: 06-composite-form-generation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/Generator/FormGenerator.php
  - src/Generator/CompositeFormGenerator.php
  - tests/phpunit/unit/Generator/CompositeFormGeneratorTest.php
autonomous: true

must_haves:
  truths:
    - "CompositeFormGenerator produces valid PageForms markup with multiple {{{for template}}} blocks"
    - "Shared properties appear once in first template section only"
    - "Each template section has a label parameter identifying the category"
    - "All selected categories get [[Category:X]] wikilinks in form output"
    - "Composite form is saved to Form: namespace via PageCreator"
    - "Form naming uses alphabetical Category1+Category2 convention"
  artifacts:
    - path: "src/Generator/CompositeFormGenerator.php"
      provides: "Composite form generation from ResolvedPropertySet"
      exports: ["generateCompositeForm", "generateAndSaveCompositeForm", "getCompositeFormName"]
      min_lines: 80
    - path: "tests/phpunit/unit/Generator/CompositeFormGeneratorTest.php"
      provides: "Comprehensive unit tests for composite form generation"
      min_lines: 100
    - path: "src/Generator/FormGenerator.php"
      provides: "Protected field generation methods accessible to CompositeFormGenerator"
      contains: "protected function generateTableField"
  key_links:
    - from: "src/Generator/CompositeFormGenerator.php"
      to: "src/Schema/ResolvedPropertySet.php"
      via: "constructor injection and generateCompositeForm parameter"
      pattern: "ResolvedPropertySet"
    - from: "src/Generator/CompositeFormGenerator.php"
      to: "src/Generator/FormGenerator.php"
      via: "inheritance - extends FormGenerator to access protected field generation methods"
      pattern: "extends FormGenerator"
    - from: "src/Generator/CompositeFormGenerator.php"
      to: "src/Store/PageCreator.php"
      via: "constructor injection for form saving"
      pattern: "PageCreator"
    - from: "src/Generator/CompositeFormGenerator.php"
      to: "src/Schema/ResolvedPropertySet.php"
      via: "isSharedProperty() for filtering shared properties in non-first sections"
      pattern: "isSharedProperty"
---

<objective>
Create CompositeFormGenerator that produces PageForms forms with multiple `{{{for template}}}` blocks for multi-category page creation, using TDD to verify wikitext output correctness.

Purpose: This is the core generator for Phase 6 -- enables creating wiki pages belonging to multiple categories from a single form. Shared properties appear once (in the first template section), and conditional `#set` from Phase 4 handles storage safely.

Output: Working CompositeFormGenerator class with comprehensive tests, FormGenerator refactored for method reuse.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-composite-form-generation/06-RESEARCH.md
@.planning/phases/04-conditional-templates/04-01-SUMMARY.md
@.planning/phases/05-property-resolution/05-01-SUMMARY.md
@src/Generator/FormGenerator.php
@src/Schema/ResolvedPropertySet.php
@src/Generator/PropertyInputMapper.php
@src/Store/PageCreator.php
@src/Util/NamingHelper.php
@tests/phpunit/unit/Schema/MultiCategoryResolverTest.php
</context>

<feature>
  <name>CompositeFormGenerator</name>
  <files>
    src/Generator/FormGenerator.php
    src/Generator/CompositeFormGenerator.php
    tests/phpunit/unit/Generator/CompositeFormGeneratorTest.php
  </files>
  <behavior>
    CompositeFormGenerator accepts a ResolvedPropertySet and produces PageForms wikitext.

    **Core generation behavior:**
    - Input: ResolvedPropertySet with 2+ categories -> Output: form wikitext string
    - Input: ResolvedPropertySet with <2 categories -> throws InvalidArgumentException
    - Output contains `<noinclude>` header with auto-generated comment and `{{#forminput:...}}`
    - Output contains `<includeonly>` body with `{{{info|page name=<page name>}}}`
    - Output contains one `{{{for template|CategoryName|label=CategoryName Properties}}}...{{{end template}}}` block per category
    - Output contains `[[Category:X]]` wikilink for every category
    - Output ends with standard inputs (summary, save, preview, changes, cancel)

    **Shared property handling (critical):**
    - First category section: ALL resolved properties shown (required + optional, including shared)
    - Subsequent category sections: ONLY category-specific properties shown (shared filtered out via isSharedProperty)
    - Properties split into "Required fields" and "Optional fields" subsections within each template section
    - Empty sections (no properties after filtering) still get {{{for template}}}...{{{end template}}} block (template must be called)

    **Field generation (reuse FormGenerator):**
    - Each property field uses FormGenerator's generateTableField() logic
    - Fields use `{{{field|param|property=PropertyName|input type=...}}}` syntax
    - Required fields get `mandatory=true` and red asterisk in label
    - PropertyInputMapper determines input type from property datatype

    **Subobject handling:**
    - Shared subobjects shown in first category section only (mirrors property behavior)
    - Category-specific subobjects shown in their respective sections
    - Subobject sections use `{{{for template|Subobject/Name|multiple}}}` with `minimum instances=1` if required

    **Naming convention:**
    - getCompositeFormName(['Person', 'Employee']) -> 'Employee+Person' (alphabetical sort, joined with +)
    - getCompositeFormName(['Z', 'A', 'M']) -> 'A+M+Z'

    **Save behavior:**
    - generateAndSaveCompositeForm(ResolvedPropertySet) -> bool
    - Saves to Form: namespace using PageCreator
    - Form name from getCompositeFormName()
    - Summary: 'SemanticSchemas: Auto-generated composite form'

    Cases:
    - Two disjoint categories (no shared props) -> two full template sections
    - Two categories with shared property -> shared in first section, filtered from second
    - Two categories where second has no unique properties -> second section has empty property table but still has {{{for template}}} block
    - Three categories with varying overlap -> correct filtering per section
    - Required/optional split within each section follows ResolvedPropertySet classification
    - Alphabetical form naming regardless of input order
  </behavior>
  <implementation>
    **Step 1: Refactor FormGenerator (prerequisite)**
    Change three methods from `private` to `protected` in FormGenerator.php:
    - `generatePropertySection()` (line 185) -> protected
    - `generateTableField()` (line 213) -> protected
    - `s()` (line 44) -> protected

    This allows CompositeFormGenerator to extend FormGenerator and reuse these methods.
    Do NOT change any method signatures or behavior -- only visibility.
    Verify existing FormGenerator tests still pass after visibility change.

    **Step 2: Create CompositeFormGenerator**
    File: `src/Generator/CompositeFormGenerator.php`
    Namespace: `MediaWiki\Extension\SemanticSchemas\Generator`

    Class extends FormGenerator (to access protected methods).
    Constructor: accepts optional PageCreator, WikiPropertyStore, PropertyInputMapper, WikiSubobjectStore (same as parent).

    Public methods:
    - `generateCompositeForm(ResolvedPropertySet $resolved): string`
    - `getCompositeFormName(array $categories): string`
    - `generateAndSaveCompositeForm(ResolvedPropertySet $resolved): bool`

    Private methods:
    - `generateTemplateSections(ResolvedPropertySet $resolved): array`
    - `generateCategorySection(string $categoryName, ResolvedPropertySet $resolved, bool $isFirst): array`
    - `getCategorySpecificProperties(array $allProperties, ResolvedPropertySet $resolved): array`
    - `generateFormInput(array $categories): string`

    Key algorithm for generateCategorySection():
    ```
    if isFirst:
      required = resolved->getRequiredProperties()
      optional = resolved->getOptionalProperties()
    else:
      allRequired = resolved->getRequiredProperties()
      allOptional = resolved->getOptionalProperties()
      required = filter(allRequired, prop -> sources include categoryName AND NOT isSharedProperty)
      optional = filter(allOptional, prop -> sources include categoryName AND NOT isSharedProperty)
    ```

    Wait -- the research says "first template section shows ALL properties (shared + specific)". But the research example (Employee+Person) shows shared "Full name" in the Employee section (first alphabetically). The categories in ResolvedPropertySet should already be sorted alphabetically by getCompositeFormName, but getCategoryNames() returns them in input order.

    IMPORTANT: Categories in the form should be processed in the ORDER returned by getCategoryNames() from ResolvedPropertySet. The form name uses alphabetical order (for deterministic naming), but template section order follows the input category order. This is consistent with the research example.

    Actually, re-reading the research example more carefully: categories ARE sorted alphabetically in the form (Employee first, then Person). The `getCompositeFormName` sorts alphabetically. The template sections should follow the same alphabetical order for consistency.

    So: sort categories alphabetically, first section gets ALL properties, subsequent sections get category-specific only.

    For determining which properties "belong to" a non-first category section:
    - A property belongs to categoryName if categoryName is in getPropertySources(prop)
    - A property is shared if isSharedProperty(prop) returns true
    - Non-first section shows: properties where sources include this category AND NOT shared

    For subobjects in non-first sections: same logic using isSharedSubobject().

    **Step 3: Create CompositeFormGeneratorTest**
    File: `tests/phpunit/unit/Generator/CompositeFormGeneratorTest.php`
    Follow patterns from MultiCategoryResolverTest (mock dependencies, assert output).

    Mock WikiPropertyStore to return PropertyModel objects for each property.
    Mock WikiSubobjectStore for subobject tests.
    Create ResolvedPropertySet directly (no need to mock -- it's a value object).

    Test cases:
    1. testThrowsForSingleCategory - InvalidArgumentException for <2 categories
    2. testDisjointCategoriesProduceTwoTemplateSections - no shared props
    3. testSharedPropertyAppearsOnlyInFirstSection - core dedup behavior
    4. testRequiredOptionalSplitWithinSections - required/optional subsections
    5. testCategoryWikilinksIncluded - [[Category:X]] for all categories
    6. testTemplateSectionLabels - label= parameter on {{{for template}}}
    7. testCompositeFormNamingAlphabetical - getCompositeFormName sorting
    8. testFormInputWithAutocomplete - {{#forminput:...}} header
    9. testGenerateAndSaveCallsPageCreator - save to Form: namespace
    10. testEmptySectionStillHasTemplateBlock - no unique props but block present
  </implementation>
</feature>

<verification>
1. Run existing FormGenerator tests to confirm protected refactor is safe:
   `php vendor/bin/phpunit tests/phpunit/unit/Generator/TemplateGeneratorTest.php`
   (FormGenerator doesn't have its own unit test file -- verify via integration or ensure no test exists)

2. Run new CompositeFormGenerator tests:
   `php vendor/bin/phpunit tests/phpunit/unit/Generator/CompositeFormGeneratorTest.php`

3. Run full test suite:
   `php vendor/bin/phpunit`

4. Run code quality checks:
   `composer test`
</verification>

<success_criteria>
- CompositeFormGenerator produces correct multi-template PageForms wikitext
- Shared properties appear ONLY in first template section
- Each template section has label= parameter
- All categories have [[Category:X]] wikilinks
- generateAndSaveCompositeForm saves to Form: namespace
- getCompositeFormName returns alphabetically sorted Category1+Category2 format
- All tests pass, composer test clean
</success_criteria>

<output>
After completion, create `.planning/phases/06-composite-form-generation/06-01-SUMMARY.md`
</output>
